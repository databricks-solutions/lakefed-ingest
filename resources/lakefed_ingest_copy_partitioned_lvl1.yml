resources:
  jobs:
    lakefed_ingest_copy_partitioned_lvl1:
      name: "lakefed_ingest_copy_partitioned_lvl1"
      description: "Performs a partitioned copy using parameters returned from get_task"
      tasks:
        - task_key: get_task
          description: "Returns parameters for the task_id provided as a job parameter"
          sql_task:
            file:
              path: ../src/lakefed_ingest/get_task.sql
            warehouse_id: ${var.warehouse_id}
        - task_key: create_sink_table
          depends_on:
            - task_key: get_task
          notebook_task:
            notebook_path: ../src/lakefed_ingest/create_sink_table.ipynb
            base_parameters:
              src_catalog: "{{tasks.get_task.output.first_row.src_catalog}}"
              src_schema: "{{tasks.get_task.output.first_row.src_schema}}"
              src_table: "{{tasks.get_task.output.first_row.src_table}}"
              select_list: "{{tasks.get_task.output.first_row.select_list}}"
              tgt_catalog: "{{tasks.get_task.output.first_row.sink_catalog}}"
              tgt_schema: "{{tasks.get_task.output.first_row.sink_schema}}"
              tgt_table: "{{tasks.get_task.output.first_row.sink_table}}"
              sink_cluster_cols: "{{tasks.get_task.output.first_row.sink_cluster_cols}}"
            source: WORKSPACE
            warehouse_id: ${var.warehouse_id}
        - task_key: generate_partitions
          depends_on:
            - task_key: create_sink_table
          notebook_task:
            notebook_path: ../src/lakefed_ingest/generate_partitions.ipynb
            base_parameters:
              partition_col: "{{tasks.get_task.output.first_row.partition_col}}"
              partition_size_mb: "{{tasks.get_task.output.first_row.partition_size_mb}}"
              src_catalog: "{{tasks.get_task.output.first_row.src_catalog}}"
              src_schema: "{{tasks.get_task.output.first_row.src_schema}}"
              src_table: "{{tasks.get_task.output.first_row.src_table}}"
              src_type: "{{tasks.get_task.output.first_row.src_type}}"
              tgt_catalog: "{{tasks.get_task.output.first_row.sink_catalog}}"
              tgt_schema: "{{tasks.get_task.output.first_row.sink_schema}}"
              tgt_table: "{{tasks.get_task.output.first_row.sink_table}}"
            source: WORKSPACE
          existing_cluster_id: ${var.cluster_id}
          libraries:
            - whl: ../dist/*.whl
          description: Gets partitions Sets taskValues used by foreach_partition
        - task_key: foreach_batch
          depends_on:
            - task_key: generate_partitions
          for_each_task:
            inputs: "{{tasks.generate_partitions.values.batch_id_list}}"
            concurrency: 1
            task:
              task_key: copy_batch
              run_job_task:
                job_id: ${resources.jobs.lakefed_ingest_copy_partitioned_lvl2.id}
                job_parameters:
                  src_schema: "{{tasks.get_task.output.first_row.src_schema}}"
                  src_catalog: "{{tasks.get_task.output.first_row.src_catalog}}"
                  src_table: "{{tasks.get_task.output.first_row.src_table}}"
                  tgt_catalog: "{{tasks.get_task.output.first_row.sink_catalog}}"
                  tgt_schema: "{{tasks.get_task.output.first_row.sink_schema}}"
                  tgt_table: "{{tasks.get_task.output.first_row.sink_table}}"
                  batch_id: "{{input}}"
              description: Copies data based on provided parameters
          description: Iterates id_list set in get_partitions task
      tags:
        business_unit: ""
        project: lakefed_ingest
      queue:
        enabled: false
      parameters:
        - name: task_id
          default: "1"
        - name: ctrl_catalog
          default: "lakefed_ingest"
        - name: ctrl_schema
          default: "default"
        - name: ctrl_table
          default: "control"